
리팩토링 포인트 : jwt 인증을 세션 클러스터 기반으로 이전 .



## 신중하게 쓰는 JWT

토이 플젝에 jwt를 적용하는 과정 중, 위화감이 드는 부분이 있어서 공부 후 정리한 글입니다. 

jwt 과  refresh 토큰의  구현, JWT 의 강점을 저해하는 요소에 대해 다룹니다.

더불어 구현에서의 선택지들에 대해서도 다룹니다.



#### JWT 를 왜 쓸까?

- 세션 스토리지를 안써도 된다. 
- 토큰을 열어보면 인가가 이루어진다. 따라서 db 에 접근할 필요도 없다  


#### 잘 알려진 JWT 의 약점 

- 탈취의 위험성 
- 이미 발행된 토큰을 컨트롤하기 어려움.


#### Refresh token 을 왜 쓸까?

짧은 주기의 access 토큰을 사용하면서, access 만료시 매번 로그인을 하지 않기 위한 방편이다.

access 를 짧게 주고 access 가 만기되었을 경우 refresh 를 이용해서 새로운 access 를 발급한다 .

이 과정에서 저장된 refresh 토큰 정보를 조회하게 되는데, 

basic auth 와 비교 강점은 조회 마다 발생하는 io 를 access 토큰 발급 기간만큼 줄여준다는 이점이 있다.

refresh 토큰도 유통기한이 있다.



#### 문제 상황 - 삭제된 유저의 살아있는 권한


[ 기능 상 문제 ]
access 토큰은 5분간 유효하고 
refresh 토큰은 1주일간 유효하다. 

1. 유저의 탈퇴
A 는 토큰을 발행한 뒤, 바로 회원 탈퇴를 해버렸다.
하지만 유저의 토큰은 아직 유효시간이 5분 남았다.


2. 어뷰징 유저
신고를 받고 급하게 A 유저가 어뷰징을 하는 것을 확인했다.
회원 db 에서 해당 유저를 soft delete 하고 모든 권한을 내려버렸다.

하지만 이사람은 아직 5분간 유효한 토큰을 가지고 있다. 신나게 불법 사이트 광고글을 올리는 것을 5분간 지켜봐야 한다. 



#### JWT 의 미쳐버린 trade off 

개발자 A 는 위의 문제점을 해결하기 위해, access 토큰이 살아있는 시간을 10초, refresh token 의 유효시간을 1주일로 설정했다.

따라서 아래와 같은 이득을 볼 수 있었다.

저장된 refresh 토큰을 지워버린다면, 유저는 10초 동안만 유효하고 새로운 access token 을 발급받지 못하고 권한은 취소된다.
바로 처리되지 않는다는 점이 찜찜하지만 10초라는 시간은 다른 비동기 요청이 늦어지는 심리적 범위(?) 에 있기 때문에 나름 합리적으로 보인다.

하지만 아래와 같은 문제가 발생한다.

보통 일반 유저들은 권한에 대한 검사가 필요한 요청 ( Create, Update, Delete ) 에 대한 요청을 그리 자주하진 않는다.
access 토큰을 너무 짧게 줘버린다면 refresh 토큰 확인을 위해  사실상 매번 세션 스토리지를 조회하기 때문에 jwt 를 쓰는 이유가 퇴색된다 .



#### 그냥 차라리 클러스터 세션을 쓰는게 어떨까 ? / JWT 사용이 강제되는 경우

이정도 오면 JWT 를 버리고, 권한에 대한 검사가 필요한 요청이 오면 session 스토리지를 매번 조회하는 것이 나름 합리적인 선택이라고 보인다.

그렇다면 JWT 사용이 꼭 권장되는 경우는 언제가 있을까 ? 



[ spring security 적용 시 구현 상 불편함 ]

1. spring security 는 jwt 에 대한 지원이 없습니다.

고작해야 필터 단위에서 연산을 용이하게 하는 onceperrequest filter 정도 ?



2. 인증 에러에 대한 처리를 controller advice 에서 진행 할 수 없습니다.

 필터 단에서 

